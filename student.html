<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒìš© ë°°ë¦¬ì–´í”„ë¦¬ í•™ìŠµ ë„ìš°ë¯¸</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #fdfdfd; }
        h1 { color: #2c3e50; text-align: center; }
        
        /* ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .section { background: white; border: 2px solid #e0e0e0; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .section h2 { margin-top: 0; font-size: 1.2rem; color: #4CAF50; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* ê²°ê³¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { border: 2px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 10px; background: #f0f7ff; }
        .braille { font-size: 24px; font-weight: bold; color: #333; letter-spacing: 2px; }
        
        /* ì±„íŒ…ì°½ ìŠ¤íƒ€ì¼ */
        #chat-box { height: 300px; overflow-y: scroll; border: 1px solid #ddd; padding: 15px; background: #fafafa; border-radius: 10px; margin-bottom: 10px; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 80%; }
        .user { background-color: #ffe082; margin-left: auto; text-align: right; }
        .bot { background-color: #ffffff; border: 1px solid #ddd; margin-right: auto; }

        /* AAC ë³´ë“œ ê·¸ë¦¬ë“œ (ë°˜ì‘í˜•) */
        .aac-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .aac-btn { 
            background: white; border: 2px solid #ddd; border-radius: 12px; padding: 10px; 
            cursor: pointer; text-align: center; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .aac-btn:hover { background-color: #e8f5e9; border-color: #4CAF50; transform: scale(1.05); }
        .aac-icon { font-size: 2.5rem; margin-bottom: 5px; } /* ì‹¤ì œ ì´ë¯¸ì§€ ì‚¬ìš©ì‹œ img íƒœê·¸ë¡œ ëŒ€ì²´ ê°€ëŠ¥ */
        .aac-label { font-size: 0.9rem; font-weight: bold; color: #333; }

        /* ì…ë ¥ì°½ ì˜ì—­ */
        .input-area { display: flex; gap: 10px; margin-top: 15px; }
        input[type="text"] { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; }
        button.send-btn { background-color: #4CAF50; color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        /* ìœ í‹¸ë¦¬í‹° */
        input[type="file"], input[type="password"] { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
        .hidden { display: none; }
        
        /* ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­ */
        .image-upload-area { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .upload-btn { 
            flex: 1; min-width: 150px; padding: 15px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px; 
            font-size: 1rem; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.3s;
        }
        .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .upload-btn.camera-btn { 
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .upload-btn.gallery-btn { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        /* ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸° */
        #cameraPreview { 
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.95); 
            z-index: 1000; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }
        #cameraPreview.active { display: flex; }
        #cameraVideo { 
            max-width: 100%; max-height: 70vh; 
            border-radius: 10px; 
            box-shadow: 0 4px 20px rgba(255,255,255,0.1);
            transform: scaleX(-1); /* ë¯¸ëŸ¬ íš¨ê³¼ */
        }
        #cameraCanvas { display: none; }
        .camera-controls { 
            margin-top: 30px; display: flex; gap: 15px; 
        }
        .camera-btn { 
            padding: 15px 30px; border: none; border-radius: 25px; 
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
            transition: all 0.3s;
        }
        .camera-btn.capture { 
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .camera-btn.cancel { 
            background: #6c757d; color: white;
        }
        .camera-btn:hover { transform: scale(1.05); }
        
        /* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° */
        #imagePreview { 
            margin-top: 15px; text-align: center; 
        }
        #imagePreview img { 
            max-width: 100%; max-height: 300px; 
            border-radius: 10px; border: 2px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <h1>ğŸ’ ë‚˜ë§Œì˜ AI í•™ìŠµ ì¹œêµ¬</h1>

    <div class="section">
        <h2>ğŸ“· êµê³¼ì„œ ë³´ì—¬ì£¼ê¸°</h2>
        <input type="password" id="apiKey" placeholder="ì„ ìƒë‹˜ì´ ì£¼ì‹  ë¹„ë°€ë²ˆí˜¸(API Key)ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í•œ ë²ˆë§Œ ì…ë ¥í•˜ë©´ ì €ì¥ë©ë‹ˆë‹¤)">
        <button onclick="saveApiKey()" style="padding:8px 15px; background:#4CAF50; color:white; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">ì €ì¥</button>
        
        <div class="image-upload-area">
            <button class="upload-btn camera-btn" onclick="openCamera()">
                ğŸ“· ì¹´ë©”ë¼ë¡œ ì´¬ì˜
            </button>
            <button class="upload-btn gallery-btn" onclick="document.getElementById('imageInput').click()">
                ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ
            </button>
        </div>
        
        <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden" onchange="handleFileSelect(event)">
        
        <div id="imagePreview"></div>
        
        <button onclick="analyzeTextbook()" style="width:100%; padding:10px; background:#2196F3; color:white; border:none; border-radius:8px; cursor:pointer; margin-top:10px;">
            ì´ë¯¸ì§€ ë¶„ì„í•˜ê³  ê³µë¶€ ì‹œì‘í•˜ê¸°
        </button>
        <div id="resultArea"></div>
    </div>
    
    <!-- ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
    <div id="cameraPreview">
        <video id="cameraVideo" autoplay playsinline></video>
        <canvas id="cameraCanvas" class="hidden"></canvas>
        <div class="camera-controls">
            <button class="camera-btn capture" onclick="capturePhoto()">ğŸ“¸ ì´¬ì˜</button>
            <button class="camera-btn cancel" onclick="closeCamera()">âŒ ì·¨ì†Œ</button>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ“ í˜•ì„±í‰ê°€</h2>
        <div id="quizArea">
            <p>êµê³¼ì„œë¥¼ ë¶„ì„í•œ í›„ í˜•ì„±í‰ê°€ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ’¬ ê·¸ë¦¼ìœ¼ë¡œ ë§í•´ìš” (AAC ì±—ë´‡)</h2>
        
        <div id="chat-box">
            <div class="msg bot">ì•ˆë…•? ê·¸ë¦¼ ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ë‚˜ë‘ ì´ì•¼ê¸°í•˜ì! ê¶ê¸ˆí•œ ê±¸ ë¬¼ì–´ë´ë„ ë¼.</div>
        </div>

        <div class="aac-grid">
            <button class="aac-btn" onclick="addAAC('ì´ê²Œ ë­ì•¼?')">
                <span class="aac-icon">â“</span> 
                <span class="aac-label">ì´ê²Œ ë­ì•¼?</span>
            </button>
            <button class="aac-btn" onclick="addAAC('ë‹¤ì‹œ ì„¤ëª…í•´ì¤˜')">
                <span class="aac-icon">ğŸ”„</span>
                <span class="aac-label">ë‹¤ì‹œ ë§í•´ì¤˜</span>
            </button>
            <button class="aac-btn" onclick="addAAC('ì–´ë ¤ì›Œìš”')">
                <span class="aac-icon">ğŸ¤¯</span>
                <span class="aac-label">ì–´ë ¤ì›Œìš”</span>
            </button>
            <button class="aac-btn" onclick="addAAC('ë„ì™€ì£¼ì„¸ìš”')">
                <span class="aac-icon">âœ‹</span>
                <span class="aac-label">ë„ì™€ì£¼ì„¸ìš”</span>
            </button>
            <button class="aac-btn" onclick="addAAC('ì¢‹ì•„ìš”')">
                <span class="aac-icon">ğŸ™†â€â™‚ï¸</span>
                <span class="aac-label">ì¢‹ì•„ìš”</span>
            </button>
            <button class="aac-btn" onclick="addAAC('ì‹«ì–´ìš”')">
                <span class="aac-icon">ğŸ™…â€â™‚ï¸</span>
                <span class="aac-label">ì‹«ì–´ìš”</span>
            </button>
            <button class="aac-btn" onclick="addAAC('ì ìë¡œ ì•Œë ¤ì¤˜')">
                <span class="aac-icon">â ¶</span>
                <span class="aac-label">ì ìë¡œ</span>
            </button>
            <button class="aac-btn" onclick="addAAC('ìˆ˜ì–´ë¡œ ë³´ì—¬ì¤˜')">
                <span class="aac-icon">ğŸ‘</span>
                <span class="aac-label">ìˆ˜ì–´ë¡œ</span>
            </button>
        </div>

        <div class="input-area">
            <input type="text" id="userMessage" placeholder="ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ê·¸ë¦¼ì„ ëˆ„ë¥´ì„¸ìš”" onkeypress="if(event.keyCode==13) sendMessage()">
            <button class="send-btn" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>

    <div class="section">
        <button onclick="submitActivity()" style="width:100%; padding:15px; background:#fd79a8; color:white; border:none; border-radius:10px; cursor:pointer; font-size:1.1rem; font-weight:bold;">
            âœ… í•™ìŠµ í™œë™ ì œì¶œí•˜ê¸°
        </button>
        <div id="submitStatus" style="margin-top:10px; padding:10px; border-radius:5px; display:none;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Firebase ì„¤ì •ê°’ (index.htmlê³¼ ë™ì¼)
        const firebaseConfig = {
            apiKey: "AIzaSyDa93D_-0bUOZA7eWE0mboYP8thA6Hw2Oc",
            authDomain: "special-dictionary-study.firebaseapp.com",
            projectId: "special-dictionary-study",
            storageBucket: "special-dictionary-study.firebasestorage.appspot.com",
            messagingSenderId: "1676901198",
            appId: "1:1676901198:web:890b3ca49f87b22a493c1f"
        };

        let db, storage, auth, currentUser;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            storage = getStorage(app);
            auth = getAuth(app);
            
            // ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ í™•ì¸
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
            });
        } catch(e) { console.log("Firebase ì„¤ì • í•„ìš”", e); }

        window.db = db;
        window.storage = storage;
        window.currentUser = () => currentUser;
        window.addDoc = addDoc;
        window.collection = collection;
        window.serverTimestamp = serverTimestamp;
        window.ref = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
    </script>

    <script>
        // ì „ì—­ ë³€ìˆ˜: ì´ë¯¸ì§€ ë¶„ì„ ë‚´ìš© ì €ì¥ìš© (ì±—ë´‡ ë¬¸ë§¥)
        let contextData = ""; 

        // [ê¸°ëŠ¥ 1] AAC ë²„íŠ¼ í´ë¦­ ì‹œ í…ìŠ¤íŠ¸ ì…ë ¥ ë° ìë™ ì „ì†¡
        function addAAC(text) {
            const input = document.getElementById('userMessage');
            input.value = text;
            sendMessage(); // ë²„íŠ¼ ëˆ„ë¥´ë©´ ë°”ë¡œ ì „ì†¡ (AAC íŠ¹ì„± ë°˜ì˜)
        }

        // [ê¸°ëŠ¥ 2] ì±—ë´‡ ë©”ì‹œì§€ ì „ì†¡ ë° GPT í†µì‹ 
        async function sendMessage() {
            // ì €ì¥ëœ API í‚¤ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì…ë ¥ í•„ë“œì—ì„œ ê°€ì ¸ì˜¤ê¸°
            let apiKey = localStorage.getItem('openai_api_key') || document.getElementById('apiKey').value;
            const input = document.getElementById('userMessage');
            const message = input.value;
            if(!message) return;

            if(!apiKey) return alert("API Keyë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”!");

            // 1. í™”ë©´ í‘œì‹œ
            appendMsg("user", message);
            input.value = "";

            // 2. ëŒ€í™” ë‚´ì—­ ì €ì¥
            const userMsg = { role: "user", content: message, timestamp: new Date().toISOString() };
            chatHistory.push(userMsg);

            // 3. GPT í˜¸ì¶œ
            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            { role: "system", content: "ë‹¹ì‹ ì€ ë°œë‹¬ì¥ì•  ë° ì‹œê°/ì²­ê° ì¥ì•  í•™ìƒì„ ìœ„í•œ ì¹œì ˆí•œ AI íŠœí„°ì…ë‹ˆë‹¤. ì‰¬ìš´ ë‹¨ì–´ì™€ ì§§ì€ ë¬¸ì¥ìœ¼ë¡œ ëŒ€ë‹µí•˜ì„¸ìš”. 'ì ì'ë¥¼ ë¬¼ì–´ë³´ë©´ ìœ ë‹ˆì½”ë“œ ì ì í…ìŠ¤íŠ¸ë¥¼, 'ìˆ˜ì–´'ë¥¼ ë¬¼ì–´ë³´ë©´ ë™ì‘ ë¬˜ì‚¬ë¥¼ í•´ì£¼ì„¸ìš”." },
                            { role: "system", content: `í˜„ì¬ í•™ìŠµì¤‘ì¸ êµê³¼ì„œ ë‚´ìš©: ${contextData}` },
                            { role: "user", content: message }
                        ]
                    })
                });
                const data = await response.json();
                const reply = data.choices[0].message.content;
                appendMsg("bot", reply);

                // ë´‡ ì‘ë‹µë„ ëŒ€í™” ë‚´ì—­ì— ì €ì¥
                const botMsg = { role: "assistant", content: reply, timestamp: new Date().toISOString() };
                chatHistory.push(botMsg);

            } catch(e) {
                console.error(e);
                appendMsg("bot", "ì˜¤ë¥˜ê°€ ë‚¬ì–´ìš”. ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•´ì£¼ì„¸ìš”.");
            }
        }

        function appendMsg(type, text) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // ì¹´ë©”ë¼ ê´€ë ¨ ë³€ìˆ˜
        let cameraStream = null;
        let capturedImageFile = null;

        // ì¹´ë©”ë¼ ì—´ê¸°
        async function openCamera() {
            const preview = document.getElementById('cameraPreview');
            const video = document.getElementById('cameraVideo');
            
            try {
                // ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œ ìš”ì²­
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment', // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                
                video.srcObject = cameraStream;
                preview.classList.add('active');
            } catch(error) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜:', error);
                alert('ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        // ì‚¬ì§„ ì´¬ì˜
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');
            
            // ë¹„ë””ì˜¤ í¬ê¸°ì— ë§ì¶° ìº”ë²„ìŠ¤ ì„¤ì •
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸° (ë¯¸ëŸ¬ íš¨ê³¼ ë°˜ì˜)
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            ctx.restore();
            
            // ìº”ë²„ìŠ¤ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
            canvas.toBlob((blob) => {
                // Blobì„ File ê°ì²´ë¡œ ë³€í™˜
                const file = new File([blob], `camera_${Date.now()}.jpg`, { type: 'image/jpeg' });
                capturedImageFile = file;
                
                // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                displayImagePreview(file);
                
                // ì¹´ë©”ë¼ ë‹«ê¸°
                closeCamera();
                
                // íŒŒì¼ ì…ë ¥ í•„ë“œì— ì„¤ì • (ê¸°ì¡´ ë¡œì§ê³¼ í˜¸í™˜)
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById('imageInput').files = dataTransfer.files;
            }, 'image/jpeg', 0.9);
        }

        // ì¹´ë©”ë¼ ë‹«ê¸°
        function closeCamera() {
            const preview = document.getElementById('cameraPreview');
            preview.classList.remove('active');
            
            // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            const video = document.getElementById('cameraVideo');
            video.srcObject = null;
        }

        // íŒŒì¼ ì„ íƒ ì²˜ë¦¬ (ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ)
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                displayImagePreview(file);
                uploadedImageFile = file;
            }
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        function displayImagePreview(file) {
            const previewDiv = document.getElementById('imagePreview');
            const reader = new FileReader();
            
            reader.onload = (e) => {
                previewDiv.innerHTML = `
                    <p style="margin-bottom: 10px; color: #4CAF50; font-weight: bold;">âœ… ì´ë¯¸ì§€ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤</p>
                    <img src="${e.target.result}" alt="ì„ íƒëœ ì´ë¯¸ì§€" style="max-width: 100%; max-height: 300px; border-radius: 10px; border: 2px solid #ddd; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <button onclick="clearImagePreview()" style="margin-top: 10px; padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                        ğŸ—‘ï¸ ì´ë¯¸ì§€ ì œê±°
                    </button>
                `;
            };
            
            reader.readAsDataURL(file);
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì œê±°
        function clearImagePreview() {
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('imageInput').value = '';
            uploadedImageFile = null;
            capturedImageFile = null;
        }

        // ì´ë¯¸ì§€ë¥¼ JPGë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function convertToJPG(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.9);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // [ê¸°ëŠ¥ 3] ì´ë¯¸ì§€ ë¶„ì„ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€ ë° ë³´ì™„)
        async function analyzeTextbook() {
            // ì €ì¥ëœ API í‚¤ ìš°ì„  ì‚¬ìš©
            let apiKey = localStorage.getItem('openai_api_key') || document.getElementById('apiKey').value;
            
            // íŒŒì¼ ì…ë ¥ í•„ë“œ ë˜ëŠ” ì´¬ì˜í•œ ì´ë¯¸ì§€ ì‚¬ìš©
            const file = document.getElementById('imageInput').files[0] || capturedImageFile;
            if(!file || !apiKey) return alert("í‚¤ì™€ ì´ë¯¸ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.");

            uploadedImageFile = file; // ë‚˜ì¤‘ì— Storageì— ì €ì¥í•˜ê¸° ìœ„í•´ ì €ì¥

            const reader = new FileReader();
            reader.onloadend = async function() {
                const base64 = reader.result.split(',')[1];
                document.getElementById('resultArea').innerHTML = "<p>ğŸ” AIê°€ êµê³¼ì„œë¥¼ ì—´ì‹¬íˆ ë³´ê³  ìˆì–´ìš”...</p>";

                try {
                    const response = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                        body: JSON.stringify({
                            model: "gpt-4o",
                            messages: [
                                {
                                    role: "system",
                                    content: "êµê³¼ì„œ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ JSONìœ¼ë¡œ ë‹µí•˜ì„¸ìš”. 1) summary: ì´ˆë“±í•™ìƒ ìˆ˜ì¤€ ìš”ì•½, 2) concepts: í•µì‹¬ ë‹¨ì–´ 3ê°œ ë¦¬ìŠ¤íŠ¸ [{word, braille, sign_desc}], 3) quiz: í˜•ì„±í‰ê°€ ë¬¸ì œ 3ê°œ [{question, options: [4ê°œ], answer: 1-4 ì¤‘ ì •ë‹µ ë²ˆí˜¸}]"
                                },
                                {
                                    role: "user",
                                    content: [ { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } } ]
                                }
                            ],
                            response_format: { type: "json_object" }
                        })
                    });

                    const data = await response.json();
                    const content = JSON.parse(data.choices[0].message.content);
                    contextData = JSON.stringify(content); // ì±—ë´‡ì´ ì•Œ ìˆ˜ ìˆê²Œ ì €ì¥
                    quizData = content.quiz; // í˜•ì„±í‰ê°€ ë°ì´í„° ì €ì¥

                    let html = `<h3>ğŸ“ ì´ë ‡ê²Œ ê³µë¶€í•´ìš”</h3><p>${content.summary}</p>`;
                    content.concepts.forEach(c => {
                        html += `<div class="card">
                            <h4>${c.word}</h4>
                            <p><strong>ì ì:</strong> <span class="braille">${c.braille}</span></p>
                            <p><strong>ìˆ˜ì–´:</strong> ${c.sign_desc}</p>
                        </div>`;
                    });
                    document.getElementById('resultArea').innerHTML = html;

                    // í˜•ì„±í‰ê°€ í‘œì‹œ
                    if (content.quiz && content.quiz.length > 0) {
                        displayQuiz(content.quiz);
                    }
                } catch(e) {
                    console.error(e);
                    document.getElementById('resultArea').innerHTML = "ë¶„ì„ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                }
            };
            reader.readAsDataURL(file);
        }

        // í˜•ì„±í‰ê°€ í‘œì‹œ í•¨ìˆ˜
        function displayQuiz(quiz) {
            let html = '<h3>ğŸ“ í˜•ì„±í‰ê°€</h3>';
            quiz.forEach((q, idx) => {
                html += `<div class="card" style="margin-bottom:15px;">
                    <p><strong>ë¬¸ì œ ${idx + 1}:</strong> ${q.question}</p>`;
                q.options.forEach((opt, optIdx) => {
                    html += `<label style="display:block; margin:5px 0; cursor:pointer;">
                        <input type="radio" name="quiz${idx}" value="${optIdx + 1}" style="margin-right:8px;">
                        ${optIdx + 1}. ${opt}
                    </label>`;
                });
                html += `</div>`;
            });
            document.getElementById('quizArea').innerHTML = html;
        }

        // ì±—ë´‡ ëŒ€í™” ë‚´ì—­ì„ ì´ë¯¸ì§€ë¡œ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ (í•™ìŠµë„ìš°ë¯¸)
        function createChatHistoryImage(chatHistory) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = 800;
                canvas.height = Math.max(600, chatHistory.length * 100 + 200);
                const ctx = canvas.getContext('2d');

                // ë°°ê²½
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // ì œëª©
                ctx.fillStyle = '#2d3436';
                ctx.font = 'bold 32px Arial';
                ctx.fillText('ğŸ’¬ í•™ìŠµë„ìš°ë¯¸ ëŒ€í™” ë‚´ì—­', 50, 50);

                // ë‚ ì§œ
                ctx.font = '18px Arial';
                ctx.fillStyle = '#636e72';
                ctx.fillText(`ë‚ ì§œ: ${new Date().toLocaleDateString('ko-KR')}`, 50, 90);

                let yPos = 140;
                chatHistory.forEach((msg, idx) => {
                    const isUser = msg.role === 'user';
                    ctx.fillStyle = isUser ? '#ffe082' : '#ffffff';
                    ctx.fillRect(50, yPos - 20, canvas.width - 100, 60);

                    // ë§í’ì„  í…Œë‘ë¦¬
                    ctx.strokeStyle = isUser ? '#ffb300' : '#ddd';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(50, yPos - 20, canvas.width - 100, 60);

                    // ë°œì‹ ì í‘œì‹œ
                    ctx.fillStyle = '#2d3436';
                    ctx.font = 'bold 14px Arial';
                    ctx.fillText(isUser ? 'ğŸ‘¤ í•™ìƒ' : 'ğŸ¤– í•™ìŠµë„ìš°ë¯¸', 60, yPos);

                    // ë©”ì‹œì§€ ë‚´ìš©
                    ctx.font = '14px Arial';
                    const lines = wrapText(ctx, msg.content, canvas.width - 120);
                    lines.forEach((line, lineIdx) => {
                        ctx.fillText(line, 60, yPos + 20 + (lineIdx * 18));
                    });

                    yPos += Math.max(60, lines.length * 18 + 30);
                });

                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', 0.9);
            });
        }

        // í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ í•¨ìˆ˜
        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + ' ' + word).width;
                if (width < maxWidth) {
                    currentLine += ' ' + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        // í˜•ì„±í‰ê°€ ê²°ê³¼ë¥¼ ì´ë¯¸ì§€ë¡œ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
        function createQuizResultImage(quizResult) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = 800;
                canvas.height = 600;
                const ctx = canvas.getContext('2d');

                // ë°°ê²½
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // ì œëª©
                ctx.fillStyle = '#2d3436';
                ctx.font = 'bold 32px Arial';
                ctx.fillText('ğŸ“ í˜•ì„±í‰ê°€ ê²°ê³¼', 50, 50);

                // ë‚ ì§œ
                ctx.font = '18px Arial';
                ctx.fillStyle = '#636e72';
                ctx.fillText(`ë‚ ì§œ: ${new Date().toLocaleDateString('ko-KR')}`, 50, 90);

                let yPos = 140;
                quizResult.questions.forEach((q, idx) => {
                    // ë¬¸ì œ ë²ˆí˜¸ì™€ ì§ˆë¬¸
                    ctx.fillStyle = '#2d3436';
                    ctx.font = 'bold 20px Arial';
                    ctx.fillText(`ë¬¸ì œ ${idx + 1}: ${q.question}`, 50, yPos);
                    yPos += 35;

                    // ì„ íƒì§€
                    ctx.font = '16px Arial';
                    q.options.forEach((opt, optIdx) => {
                        const isSelected = quizResult.answers[idx] === (optIdx + 1);
                        const isCorrect = q.answer === (optIdx + 1);
                        
                        if (isSelected) {
                            ctx.fillStyle = isCorrect ? '#28a745' : '#dc3545';
                        } else {
                            ctx.fillStyle = isCorrect ? '#17a2b8' : '#6c757d';
                        }
                        
                        const marker = isSelected ? (isCorrect ? 'âœ“' : 'âœ—') : (isCorrect ? 'â†’' : 'â—‹');
                        ctx.fillText(`${marker} ${optIdx + 1}. ${opt}`, 70, yPos);
                        yPos += 25;
                    });

                    // ì •ë‹µ í‘œì‹œ
                    if (quizResult.answers[idx] !== null) {
                        const isCorrect = quizResult.answers[idx] === q.answer;
                        ctx.fillStyle = isCorrect ? '#28a745' : '#dc3545';
                        ctx.font = 'bold 16px Arial';
                        ctx.fillText(
                            isCorrect ? 'âœ… ì •ë‹µì…ë‹ˆë‹¤!' : `âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µ: ${q.answer}`,
                            70,
                            yPos
                        );
                        yPos += 40;
                    } else {
                        yPos += 20;
                    }
                });

                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', 0.9);
            });
        }

        // í•™ìŠµ í™œë™ ì œì¶œ í•¨ìˆ˜
        async function submitActivity() {
            const statusDiv = document.getElementById('submitStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p>â³ ì œì¶œ ì¤‘...</p>';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.border = '2px solid #ffc107';

            try {
                const user = window.currentUser();
                if (!user) {
                    throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. index.htmlì—ì„œ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                }

                const userId = user.uid;
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
                const timestamp = new Date();

                // 1. ëŒ€í™” ë‚´ì—­ì„ Firestoreì— ì €ì¥
                if (chatHistory.length > 0 && window.db) {
                    await window.addDoc(window.collection(window.db, "student_chat_history"), {
                        userId: userId,
                        date: today,
                        chatHistory: chatHistory,
                        timestamp: window.serverTimestamp()
                    });
                }

                // 2. í™œë™ ë‚ ì§œë¥¼ ë³„ë„ë¡œ ì €ì¥
                if (window.db) {
                    await window.addDoc(window.collection(window.db, "student_activity_dates"), {
                        userId: userId,
                        date: today,
                        timestamp: window.serverTimestamp()
                    });
                }

                // 3. êµê³¼ì„œ ì´ë¯¸ì§€ë¥¼ Storageì— JPGë¡œ ì €ì¥
                if (uploadedImageFile && window.storage) {
                    const jpgBlob = await convertToJPG(uploadedImageFile);
                    const imageRef = window.ref(window.storage, `textbooks/${userId}/${timestamp.getTime()}_textbook.jpg`);
                    await window.uploadBytes(imageRef, jpgBlob);
                }

                // 3-1. ì±—ë´‡ ëŒ€í™” ë‚´ì—­ì„ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•˜ì—¬ Storageì— ì €ì¥ (í•™ìŠµë„ìš°ë¯¸)
                if (chatHistory.length > 0 && window.storage) {
                    const chatImageBlob = await createChatHistoryImage(chatHistory);
                    if (chatImageBlob) {
                        const chatImageRef = window.ref(window.storage, `chat_history/${userId}/${timestamp.getTime()}_chat_history.jpg`);
                        await window.uploadBytes(chatImageRef, chatImageBlob);
                    }
                }

                // 4. í˜•ì„±í‰ê°€ ê²°ê³¼ë¥¼ ì´ë¯¸ì§€ë¡œ ìƒì„±í•˜ì—¬ Storageì— ì €ì¥
                if (quizData && window.storage) {
                    const quizResult = {
                        questions: quizData,
                        answers: quizData.map((q, idx) => {
                            const selected = document.querySelector(`input[name="quiz${idx}"]:checked`);
                            return selected ? parseInt(selected.value) : null;
                        })
                    };

                    // í˜•ì„±í‰ê°€ ê²°ê³¼ë¥¼ Firestoreì— ì €ì¥
                    if (window.db) {
                        await window.addDoc(window.collection(window.db, "student_quiz_results"), {
                            userId: userId,
                            date: today,
                            quizData: quizResult,
                            timestamp: window.serverTimestamp()
                        });
                    }

                    // í˜•ì„±í‰ê°€ ê²°ê³¼ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•˜ì—¬ Storageì— ì €ì¥
                    const quizImageBlob = await createQuizResultImage(quizResult);
                    if (quizImageBlob) {
                        const quizImageRef = window.ref(window.storage, `quiz_results/${userId}/${timestamp.getTime()}_quiz_result.jpg`);
                        await window.uploadBytes(quizImageRef, quizImageBlob);
                    }
                }

                statusDiv.innerHTML = '<p>âœ… ì œì¶œ ì™„ë£Œ! ëŒ€í™” ë‚´ì—­ê³¼ í™œë™ ë‚ ì§œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
                statusDiv.style.background = '#d4edda';
                statusDiv.style.border = '2px solid #28a745';

            } catch(e) {
                console.error('ì œì¶œ ì˜¤ë¥˜:', e);
                statusDiv.innerHTML = `<p>âŒ ì œì¶œ ì‹¤íŒ¨: ${e.message}</p>`;
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.border = '2px solid #dc3545';
            }
        }
    </script>
</body>
</html>
