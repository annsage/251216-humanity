<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ìš© UDL ì„¤ê³„ ë„ìš°ë¯¸</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 50%, #fd79a8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        h1 {
            color: #2d3436;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #636e72;
            font-size: 1rem;
            margin-bottom: 30px;
        }

        .upload-section {
            background: linear-gradient(135deg, #fff5e6 0%, #ffe8d6 100%);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #fd79a8;
        }

        .upload-section label {
            display: block;
            margin-bottom: 10px;
            color: #2d3436;
            font-weight: 500;
        }

        .upload-section input[type="password"],
        .upload-section input[type="file"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: 'Noto Sans KR', sans-serif;
            margin-bottom: 15px;
        }

        .upload-section input[type="password"] {
            width: 100%;
            max-width: 400px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 20px;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            background: white;
            padding: 20px;
            margin-top: 20px;
            border-radius: 20px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .msg {
            margin-bottom: 20px;
            padding: 15px 20px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 5px solid #2196F3;
            margin-right: auto;
        }

        .user {
            background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%);
            border-right: 5px solid #8bc34a;
            margin-left: auto;
            text-align: right;
        }

        .input-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .input-group input[type="text"] {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            font-family: 'Noto Sans KR', sans-serif;
            transition: border-color 0.3s;
        }

        .input-group input[type="text"]:focus {
            outline: none;
            border-color: #74b9ff;
        }

        .input-group button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(33, 150, 243, 0.3);
            border-radius: 50%;
            border-top-color: #2196F3;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .extracted-info {
            background: linear-gradient(135deg, #fff9e6 0%, #fff5d6 100%);
            border: 2px solid #fdcb6e;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .extracted-info h3 {
            color: #2d3436;
            font-size: 1.2rem;
            margin-bottom: 15px;
            border-bottom: 2px solid #fdcb6e;
            padding-bottom: 10px;
        }

        .extracted-info .info-item {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
        }

        .extracted-info .info-item strong {
            color: #0984e3;
            display: block;
            margin-bottom: 5px;
        }

        .extracted-info .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        .extracted-info .keyword-tag {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .extracted-info .support-method {
            margin-top: 10px;
            padding: 10px;
            background: rgba(116, 185, 255, 0.1);
            border-left: 3px solid #74b9ff;
            border-radius: 5px;
        }

        .extracted-info .support-method strong {
            color: #0984e3;
        }

        .extracted-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .extracted-info li {
            margin: 5px 0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‘©â€ğŸ« UDL(ë³´í¸ì  í•™ìŠµ ì„¤ê³„) ì½”ì¹­ ë´‡</h1>
        <p class="subtitle">êµì‚¬ìš© ì§€ë„ì„œë‚˜ ìˆ˜ì—… ìë£Œë¥¼ ì—…ë¡œë“œí•˜ë©´, ì¥ì•  íŠ¹ì„±ì— ë§ëŠ” ìˆ˜ì—… ìˆ˜ì • ì „ëµì„ ì œì•ˆí•©ë‹ˆë‹¤.</p>

        <div class="upload-section">
            <label>ğŸ”‘ OpenAI API Key:</label>
            <input type="password" id="apiKey" placeholder="sk-... (í•œ ë²ˆë§Œ ì…ë ¥í•˜ë©´ ì €ì¥ë©ë‹ˆë‹¤)">
            <button onclick="saveApiKey()" style="padding:8px 15px; background:#4CAF50; color:white; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">ì €ì¥</button>
            <br>
            <label>ğŸ“„ ì§€ë„ì„œ/ìˆ˜ì—…ìë£Œ ì—…ë¡œë“œ:</label>
            <input type="file" id="guideInput" accept="image/*">
            <br>
            <button onclick="analyzeGuide()" class="btn">ğŸ“Š ì§€ë„ì„œ ë¶„ì„ ë° ì½”ì¹­ ì‹œì‘</button>
        </div>

        <div class="chat-container" id="chatBox">
            <div class="msg ai">
                ì•ˆë…•í•˜ì„¸ìš” ì„ ìƒë‹˜! ğŸ‘‹<br><br>
                ì˜¤ëŠ˜ ìˆ˜ì—… ìë£Œë¥¼ ì˜¬ë ¤ì£¼ì‹œë©´, ì‹œê°Â·ì²­ê° ì¥ì•  í•™ìƒì„ í¬í•¨í•œ ëª¨ë“  í•™ìƒì„ ìœ„í•œ UDL(ë³´í¸ì  í•™ìŠµ ì„¤ê³„) ìˆ˜ì—… ì„¤ê³„ë¥¼ ë„ì™€ë“œë¦´ê²Œìš”.<br><br>
                ì§€ë„ì„œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì‹œë©´, í•™ìŠµ ë‚´ìš©ê³¼ í•µì‹¬ í‚¤ì›Œë“œë¥¼ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ê³ , ê° í•™ìƒì˜ íŠ¹ì„±ì— ë§ëŠ” ë§ì¶¤í˜• êµìœ¡ ë°©ë²•ì„ ì œì•ˆí•´ë“œë¦½ë‹ˆë‹¤. ğŸ’¡
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="userMsg" placeholder="ì˜ˆ: ì²­ê°ì¥ì•  í•™ìƒì„ ìœ„í•´ ì´ ê°œë…ì„ ì–´ë–»ê²Œ ì„¤ëª…í• ê¹Œ?" onkeypress="if(event.keyCode==13) sendChat()">
            <button onclick="sendChat()" class="btn">ì „ì†¡</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Firebase ì„¤ì •ê°’ (index.htmlê³¼ ë™ì¼)
        const firebaseConfig = {
            apiKey: "AIzaSyDa93D_-0bUOZA7eWE0mboYP8thA6Hw2Oc",
            authDomain: "special-dictionary-study.firebaseapp.com",
            projectId: "special-dictionary-study",
            storageBucket: "special-dictionary-study.firebasestorage.appspot.com",
            messagingSenderId: "1676901198",
            appId: "1:1676901198:web:890b3ca49f87b22a493c1f"
        };

        let auth, currentUser;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            
            // ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ í™•ì¸
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
            });
        } catch(e) { console.log("Firebase ì„¤ì • í•„ìš”", e); }
    </script>

    <script>
        let context = ""; // ì§€ë„ì„œ ë‚´ìš© ì €ì¥ìš©
        let uploadedImageBase64 = ""; // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ì €ì¥
        let extractedData = null; // ì¶”ì¶œëœ êµ¬ì¡°í™”ëœ ë°ì´í„°

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('DOMContentLoaded', () => {
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
        });

        // API í‚¤ ì €ì¥ í•¨ìˆ˜
        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
                alert('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        async function analyzeGuide() {
            // ì €ì¥ëœ API í‚¤ ìš°ì„  ì‚¬ìš©
            let apiKey = localStorage.getItem('openai_api_key') || document.getElementById('apiKey').value;
            const file = document.getElementById('guideInput').files[0];
            if(!file) return alert("ì§€ë„ì„œ ì´ë¯¸ì§€ë¥¼ ì˜¬ë ¤ì£¼ì„¸ìš”.");
            if(!apiKey) return alert("OpenAI API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            addMsg("user", "ì§€ë„ì„œ ë¶„ì„ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤...");
            const loadingMsg = addLoadingMsg();
            
            const reader = new FileReader();
            reader.onloadend = async function() {
                const base64 = reader.result.split(',')[1];
                uploadedImageBase64 = base64;
                
                // JSON í˜•ì‹ìœ¼ë¡œ êµ¬ì¡°í™”ëœ ì •ë³´ ì¶”ì¶œ ìš”ì²­
                const systemPrompt = `ë‹¹ì‹ ì€ 'íŠ¹ìˆ˜êµìœ¡ ë° UDL(ë³´í¸ì  í•™ìŠµ ì„¤ê³„) ì „ë¬¸ê°€'ì…ë‹ˆë‹¤. 
ì—…ë¡œë“œëœ êµì‚¬ìš© ì§€ë„ì„œ ì´ë¯¸ì§€ë¥¼ ë§¤ìš° ì£¼ì˜ê¹Šê²Œ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ì •ë³´ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œí•´ì£¼ì„¸ìš”.

**ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:**
{
    "subject": "í•™ìŠµ ì£¼ì œ/ë‹¨ì›ëª…",
    "learningObjectives": ["í•™ìŠµ ëª©í‘œ 1", "í•™ìŠµ ëª©í‘œ 2", ...],
    "coreContent": "í•µì‹¬ í•™ìŠµ ë‚´ìš© ìš”ì•½",
    "keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3", ...],
    "activityKeywords": ["í•™ìŠµ í™œë™ ê´€ë ¨ í‚¤ì›Œë“œ1", "í•™ìŠµ í™œë™ ê´€ë ¨ í‚¤ì›Œë“œ2", ...],
    "supportMethods": {
        "visualImpairment": {
            "description": "ì‹œê°ì¥ì•  í•™ìƒì„ ìœ„í•œ ë§ì¶¤ ì§€ì› ë°©ë²•",
            "brailleWords": ["ì ìë¡œ ì œê³µí•  ë‹¨ì–´1", "ì ìë¡œ ì œê³µí•  ë‹¨ì–´2", ...],
            "tactileMaterials": ["ì´‰ê° ìë£Œ ì•„ì´ë””ì–´1", "ì´‰ê° ìë£Œ ì•„ì´ë””ì–´2", ...]
        },
        "hearingImpairment": {
            "description": "ì²­ê°ì¥ì•  í•™ìƒì„ ìœ„í•œ ë§ì¶¤ ì§€ì› ë°©ë²•",
            "signLanguageWords": ["ìˆ˜ì–´ë¡œ ì œê³µí•  ë‹¨ì–´1", "ìˆ˜ì–´ë¡œ ì œê³µí•  ë‹¨ì–´2", ...],
            "visualSupports": ["ì‹œê°ì  ì§€ì› ì•„ì´ë””ì–´1", "ì‹œê°ì  ì§€ì› ì•„ì´ë””ì–´2", ...]
        },
        "otherDisabilities": {
            "description": "ê¸°íƒ€ ì¥ì•  ìœ í˜•ë³„ ë§ì¶¤ ì§€ì› ë°©ë²•"
        }
    },
    "extractionConfidence": "high" | "medium" | "low",
    "missingInfo": ["ì¶”ì¶œí•˜ì§€ ëª»í•œ ì •ë³´1", "ì¶”ì¶œí•˜ì§€ ëª»í•œ ì •ë³´2", ...]
}

**ì¤‘ìš” ì§€ì‹œì‚¬í•­:**
1. ì´ë¯¸ì§€ì˜ ëª¨ë“  í…ìŠ¤íŠ¸ë¥¼ ê°€ëŠ¥í•œ í•œ ì •í™•í•˜ê²Œ ì½ì–´ì£¼ì„¸ìš” (OCR ê¸°ëŠ¥ì„ ìµœëŒ€í•œ í™œìš©)
2. í•™ìŠµ í™œë™ ê´€ë ¨ í‚¤ì›Œë“œë¥¼ ë³„ë„ë¡œ ì¶”ì¶œí•´ì£¼ì„¸ìš”
3. ì¥ì•  ìœ í˜•ë³„ ë§ì¶¤ ì§€ì› ë°©ë²•ì„ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œí•´ì£¼ì„¸ìš”
4. ì¶”ì¶œì´ ì–´ë ¤ìš´ ê²½ìš° extractionConfidenceë¥¼ "low" ë˜ëŠ” "medium"ìœ¼ë¡œ ì„¤ì •í•˜ê³  missingInfoì— ëˆ„ë½ëœ ì •ë³´ë¥¼ ëª…ì‹œí•´ì£¼ì„¸ìš”
5. ë§Œì•½ ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì™„ì „íˆ ì½ê¸° ì–´ë µë‹¤ë©´, ì´ë¯¸ì§€ì˜ ì‹œê°ì  ìš”ì†Œ(ê·¸ë¦¼, í‘œ, ë ˆì´ì•„ì›ƒ ë“±)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¶”ë¡ í•´ì£¼ì„¸ìš”`;

                const userPrompt = `ì´ êµì‚¬ìš© ì§€ë„ì„œ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ìœ„ì˜ JSON í˜•ì‹ìœ¼ë¡œ êµ¬ì¡°í™”ëœ ì •ë³´ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”. 
íŠ¹íˆ í•™ìŠµ ë‚´ìš©, í•™ìŠµ ëª©í‘œ, í•µì‹¬ í‚¤ì›Œë“œ, í•™ìŠµ í™œë™ ê´€ë ¨ í‚¤ì›Œë“œ, ê·¸ë¦¬ê³  ì¥ì•  ìœ í˜•ë³„ ë§ì¶¤ ì§€ì› ë°©ë²•ì„ ëª…í™•íˆ ì¶”ì¶œí•´ì£¼ì„¸ìš”.`;

                try {
                    const response = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/json", 
                            "Authorization": `Bearer ${apiKey}` 
                        },
                        body: JSON.stringify({
                            model: "gpt-4o",
                            messages: [
                                { role: "system", content: systemPrompt },
                                { 
                                    role: "user", 
                                    content: [
                                        { type: "text", text: userPrompt },
                                        { 
                                            type: "image_url", 
                                            image_url: { 
                                                url: `data:image/jpeg;base64,${base64}`,
                                                detail: "high"
                                            } 
                                        }
                                    ]
                                }
                            ],
                            response_format: { type: "json_object" },
                            max_tokens: 3000
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }

                    const reply = data.choices[0].message.content;
                    let parsedData;
                    
                    try {
                        parsedData = JSON.parse(reply);
                        extractedData = parsedData;
                    } catch (parseError) {
                        // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬
                        console.warn("JSON íŒŒì‹± ì‹¤íŒ¨, í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬:", parseError);
                        parsedData = null;
                    }

                    removeLoadingMsg(loadingMsg);
                    
                    // ì¶”ì¶œëœ ì •ë³´ê°€ ìˆê³  ì‹ ë¢°ë„ê°€ ë†’ì€ ê²½ìš° êµ¬ì¡°í™”ëœ ì •ë³´ í‘œì‹œ
                    if (parsedData && parsedData.extractionConfidence === "high") {
                        displayExtractedInfo(parsedData);
                        context = JSON.stringify(parsedData, null, 2);
                    } else if (parsedData && (parsedData.extractionConfidence === "medium" || parsedData.extractionConfidence === "low")) {
                        // ì¶”ì¶œì´ ë¶ˆì™„ì „í•œ ê²½ìš° ì§ˆë¬¸í•˜ëŠ” ì±—ë´‡ í™œì„±í™”
                        displayExtractedInfo(parsedData);
                        await askForMissingInfo(apiKey, base64, parsedData);
                        context = JSON.stringify(parsedData, null, 2);
                    } else {
                        // JSON íŒŒì‹± ì‹¤íŒ¨ ë˜ëŠ” ì¶”ì¶œ ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ ì‘ë‹µ í‘œì‹œ
                        context = reply;
                        addMsg("ai", reply);
                        // ì¶”ì¶œì´ ì–´ë ¤ìš´ ê²½ìš° ì§ˆë¬¸ ì±—ë´‡ í™œì„±í™”
                        await askForMissingInfo(apiKey, base64, null);
                    }
                    
                } catch(e) {
                    console.error("ì´ë¯¸ì§€ ë¶„ì„ ì˜¤ë¥˜:", e);
                    removeLoadingMsg(loadingMsg);
                    
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•™ìŠµë‚´ìš©ê³¼ ëª©í‘œë¥¼ ë¬»ëŠ” ì±—ë´‡ ì‘ë‹µ ìƒì„±
                    await handleAnalysisError(apiKey, base64, e);
                }
            };
            reader.readAsDataURL(file);
        }

        // ì¶”ì¶œëœ ì •ë³´ë¥¼ êµ¬ì¡°í™”ëœ í˜•íƒœë¡œ í‘œì‹œ
        function displayExtractedInfo(data) {
            if (!data) return;

            let html = '<div class="extracted-info">';
            html += '<h3>ğŸ“‹ ì¶”ì¶œëœ í•™ìŠµ ì •ë³´</h3>';

            if (data.subject) {
                html += `<div class="info-item"><strong>ğŸ“š í•™ìŠµ ì£¼ì œ/ë‹¨ì›ëª…:</strong> ${data.subject}</div>`;
            }

            if (data.learningObjectives && data.learningObjectives.length > 0) {
                html += `<div class="info-item"><strong>ğŸ¯ í•™ìŠµ ëª©í‘œ:</strong><ul>`;
                data.learningObjectives.forEach(obj => {
                    html += `<li>${obj}</li>`;
                });
                html += `</ul></div>`;
            }

            if (data.coreContent) {
                html += `<div class="info-item"><strong>ğŸ“ í•µì‹¬ í•™ìŠµ ë‚´ìš©:</strong> ${data.coreContent}</div>`;
            }

            if (data.keywords && data.keywords.length > 0) {
                html += `<div class="info-item"><strong>ğŸ”‘ ì£¼ìš” í‚¤ì›Œë“œ:</strong><div class="keywords">`;
                data.keywords.forEach(keyword => {
                    html += `<span class="keyword-tag">${keyword}</span>`;
                });
                html += `</div></div>`;
            }

            if (data.activityKeywords && data.activityKeywords.length > 0) {
                html += `<div class="info-item"><strong>ğŸ® í•™ìŠµ í™œë™ ê´€ë ¨ í‚¤ì›Œë“œ:</strong><div class="keywords">`;
                data.activityKeywords.forEach(keyword => {
                    html += `<span class="keyword-tag">${keyword}</span>`;
                });
                html += `</div></div>`;
            }

            if (data.supportMethods) {
                html += `<div class="info-item"><strong>â™¿ ì¥ì•  ìœ í˜•ë³„ ë§ì¶¤ ì§€ì› ë°©ë²•:</strong>`;
                
                if (data.supportMethods.visualImpairment) {
                    const vi = data.supportMethods.visualImpairment;
                    html += `<div class="support-method"><strong>ğŸ‘ï¸ ì‹œê°ì¥ì•  í•™ìƒ:</strong> ${vi.description || ''}`;
                    if (vi.brailleWords && vi.brailleWords.length > 0) {
                        html += `<br>ì ì í•„ìš” ë‹¨ì–´: ${vi.brailleWords.join(', ')}`;
                    }
                    if (vi.tactileMaterials && vi.tactileMaterials.length > 0) {
                        html += `<br>ì´‰ê° ìë£Œ: ${vi.tactileMaterials.join(', ')}`;
                    }
                    html += `</div>`;
                }

                if (data.supportMethods.hearingImpairment) {
                    const hi = data.supportMethods.hearingImpairment;
                    html += `<div class="support-method"><strong>ğŸ‘‚ ì²­ê°ì¥ì•  í•™ìƒ:</strong> ${hi.description || ''}`;
                    if (hi.signLanguageWords && hi.signLanguageWords.length > 0) {
                        html += `<br>ìˆ˜ì–´ í•„ìš” ë‹¨ì–´: ${hi.signLanguageWords.join(', ')}`;
                    }
                    if (hi.visualSupports && hi.visualSupports.length > 0) {
                        html += `<br>ì‹œê°ì  ì§€ì›: ${hi.visualSupports.join(', ')}`;
                    }
                    html += `</div>`;
                }

                if (data.supportMethods.otherDisabilities) {
                    html += `<div class="support-method"><strong>â™¿ ê¸°íƒ€ ì¥ì•  ìœ í˜•:</strong> ${data.supportMethods.otherDisabilities.description || ''}</div>`;
                }

                html += `</div>`;
            }

            if (data.extractionConfidence) {
                const confidenceText = {
                    "high": "ë†’ìŒ âœ…",
                    "medium": "ë³´í†µ âš ï¸",
                    "low": "ë‚®ìŒ âŒ"
                };
                html += `<div class="info-item"><strong>ğŸ“Š ì¶”ì¶œ ì‹ ë¢°ë„:</strong> ${confidenceText[data.extractionConfidence] || data.extractionConfidence}</div>`;
            }

            html += '</div>';
            addMsg("ai", html);
        }

        // ëˆ„ë½ëœ ì •ë³´ë¥¼ ë¬»ëŠ” ì±—ë´‡
        async function askForMissingInfo(apiKey, base64, extractedData) {
            let missingInfoList = [];
            
            if (extractedData && extractedData.missingInfo && extractedData.missingInfo.length > 0) {
                missingInfoList = extractedData.missingInfo;
            } else if (!extractedData || extractedData.extractionConfidence !== "high") {
                missingInfoList = ["í•™ìŠµ ì£¼ì œ/ë‹¨ì›ëª…", "í•™ìŠµ ëª©í‘œ", "í•µì‹¬ í•™ìŠµ ë‚´ìš©", "ì£¼ìš” í‚¤ì›Œë“œ", "í•™ìŠµ í™œë™", "ì¥ì•  ìœ í˜•ë³„ ì§€ì› ë°©ë²•"];
            }

            const questionPrompt = `ë‹¤ìŒ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” ë° ì–´ë ¤ì›€ì´ ìˆì—ˆìŠµë‹ˆë‹¤:
${missingInfoList.map((info, idx) => `${idx + 1}. ${info}`).join('\n')}

ì„ ìƒë‹˜ê»˜ì„œ ë‹¤ìŒ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì‹œë©´, ë” ì •í™•í•œ ë§ì¶¤í˜• êµìœ¡ ë°©ë²•ì„ ì œì•ˆí•´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
1. ì´ ìˆ˜ì—…ì˜ ì£¼ì œë‚˜ ë‹¨ì›ëª…ì€ ë¬´ì—‡ì¸ê°€ìš”?
2. ì´ë²ˆ ìˆ˜ì—…ì˜ í•™ìŠµ ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€ìš”? (êµ¬ì²´ì ìœ¼ë¡œ)
3. í•µì‹¬ í•™ìŠµ ë‚´ìš©ì„ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”.
4. ì£¼ìš” í‚¤ì›Œë“œë‚˜ í•™ìŠµ í™œë™ ê´€ë ¨ í‚¤ì›Œë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.
5. ì–´ë–¤ í•™ìƒë“¤ì„ ìœ„í•œ ìˆ˜ì •ì´ í•„ìš”í•œê°€ìš”? (ì‹œê°ì¥ì• , ì²­ê°ì¥ì• , ê¸°íƒ€ ë“±)

ë˜ëŠ” ì´ë¯¸ì§€ì˜ ì‹œê°ì  ìš”ì†Œë¥¼ ë°”íƒ•ìœ¼ë¡œ ì œê°€ ë” ë¶„ì„í•´ë“œë¦´ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.`;

            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json", 
                        "Authorization": `Bearer ${apiKey}` 
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            { 
                                role: "system", 
                                content: `ë‹¹ì‹ ì€ ì¹œì ˆí•œ UDL ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼ê°€ ë¶ˆì™„ì „í•˜ë”ë¼ë„, ì´ë¯¸ì§€ì˜ ì‹œê°ì  ìš”ì†Œë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìŠµ ë‚´ìš©ì„ íŒŒì•…í•˜ê³  ì„ ìƒë‹˜ê»˜ ë„ì›€ì´ ë˜ëŠ” ì§ˆë¬¸ì„ í•˜ê±°ë‚˜, ê°€ëŠ¥í•œ ì •ë³´ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.` 
                            },
                            { 
                                role: "user", 
                                content: [
                                    { 
                                        type: "text", 
                                        text: `${questionPrompt}\n\nì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•˜ì—¬ ê°€ëŠ¥í•œ ì •ë³´ë¥¼ ì œê³µí•˜ê±°ë‚˜, ì„ ìƒë‹˜ê»˜ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.` 
                                    },
                                    { 
                                        type: "image_url", 
                                        image_url: { 
                                            url: `data:image/jpeg;base64,${base64}`,
                                            detail: "high"
                                        } 
                                    }
                                ]
                            }
                        ],
                        max_tokens: 1500
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        const reply = data.choices[0].message.content;
                        addMsg("ai", questionPrompt + "\n\n---\n\n" + reply);
                        return;
                    }
                }
            } catch (fallbackError) {
                console.error("ì§ˆë¬¸ ì±—ë´‡ ì˜¤ë¥˜:", fallbackError);
            }
            
            // ìµœì¢… ëŒ€ì²´: ê¸°ë³¸ ì§ˆë¬¸ ë©”ì‹œì§€
            addMsg("ai", questionPrompt);
        }

        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ëŒ€ì²´ ì²˜ë¦¬: ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•™ìŠµë‚´ìš©ê³¼ ëª©í‘œë¥¼ ë¬»ëŠ” ì±—ë´‡
        async function handleAnalysisError(apiKey, base64, error) {
            const errorPrompt = `ì´ë¯¸ì§€ ë¶„ì„ ì¤‘ ê¸°ìˆ ì  ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ê±±ì •í•˜ì§€ ë§ˆì„¸ìš”!

ì—…ë¡œë“œí•˜ì‹  ì§€ë„ì„œ ì´ë¯¸ì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì„ ìƒë‹˜ê»˜ ëª‡ ê°€ì§€ ì§ˆë¬¸ì„ ë“œë ¤ì„œ ìˆ˜ì—… ì„¤ê³„ë¥¼ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ë‹¤ìŒ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì‹œë©´, ì¥ì•  íŠ¹ì„±ì— ë§ëŠ” ìˆ˜ì—… ìˆ˜ì • ì „ëµì„ ì œì•ˆí•´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
1. ì´ ìˆ˜ì—…ì˜ ì£¼ì œë‚˜ ë‹¨ì›ëª…ì€ ë¬´ì—‡ì¸ê°€ìš”?
2. ì´ë²ˆ ìˆ˜ì—…ì˜ í•™ìŠµ ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€ìš”? (êµ¬ì²´ì ìœ¼ë¡œ)
3. í•µì‹¬ í•™ìŠµ ë‚´ìš©ì„ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”.
4. ì£¼ìš” í‚¤ì›Œë“œë‚˜ í•™ìŠµ í™œë™ ê´€ë ¨ í‚¤ì›Œë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.
5. ì–´ë–¤ í•™ìƒë“¤ì„ ìœ„í•œ ìˆ˜ì •ì´ í•„ìš”í•œê°€ìš”? (ì‹œê°ì¥ì• , ì²­ê°ì¥ì•  ë“±)

ë˜ëŠ” ì´ë¯¸ì§€ì˜ ì‹œê°ì  ìš”ì†Œë¥¼ ë°”íƒ•ìœ¼ë¡œ ì œê°€ ì¶”ë¡ í•˜ì—¬ ë„ì›€ì„ ë“œë¦´ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.`;

            // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì§ˆë¬¸ ì±—ë´‡ í™œì„±í™”
            await askForMissingInfo(apiKey, base64, null);
        }

        async function sendChat() {
            // ì €ì¥ëœ API í‚¤ ìš°ì„  ì‚¬ìš©
            let apiKey = localStorage.getItem('openai_api_key') || document.getElementById('apiKey').value;
            const msg = document.getElementById('userMsg').value;
            if(!msg) return;
            if(!apiKey) return alert("OpenAI API Keyë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.");

            addMsg("user", msg);
            document.getElementById('userMsg').value = "";
            const loadingMsg = addLoadingMsg();

            try {
                let systemContent = "ë‹¹ì‹ ì€ UDL ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì•ì„œ ë¶„ì„í•œ ì§€ë„ì„œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì„ ìƒë‹˜ì˜ ì§ˆë¬¸ì— êµ¬ì²´ì ì¸ êµìœ¡ì  ì¡°ì–¸ì„ í•´ì£¼ì„¸ìš”.";
                
                // ì¶”ì¶œëœ êµ¬ì¡°í™”ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í™œìš©
                if (extractedData) {
                    systemContent += `\n\në‹¤ìŒì€ ì¶”ì¶œëœ í•™ìŠµ ì •ë³´ì…ë‹ˆë‹¤:\n${JSON.stringify(extractedData, null, 2)}`;
                }

                const messages = [
                    { 
                        role: "system", 
                        content: systemContent
                    }
                ];

                // ì´ì „ ë¶„ì„ ë‚´ìš©ì´ ìˆìœ¼ë©´ ì¶”ê°€ (ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—†ì„ ë•Œë§Œ)
                if (context && !extractedData) {
                    messages.push({ role: "assistant", content: context });
                }

                // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ì— í¬í•¨
                const userContent = [{ type: "text", text: msg }];
                if (uploadedImageBase64) {
                    userContent.push({
                        type: "image_url",
                        image_url: {
                            url: `data:image/jpeg;base64,${uploadedImageBase64}`,
                            detail: "high"
                        }
                    });
                }
                messages.push({ role: "user", content: userContent });

                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json", 
                        "Authorization": `Bearer ${apiKey}` 
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: messages,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                removeLoadingMsg(loadingMsg);
                addMsg("ai", data.choices[0].message.content);
            } catch(e) {
                console.error("ì±—ë´‡ ì˜¤ë¥˜:", e);
                removeLoadingMsg(loadingMsg);
                addMsg("ai", `ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
            }
        }

        function addMsg(type, text) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = text.replace(/\n/g, "<br>"); // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return div;
        }

        function addLoadingMsg() {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = "msg ai";
            div.id = "loading-msg";
            div.innerHTML = '<span class="loading"></span> ë¶„ì„ ì¤‘...';
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return div;
        }

        function removeLoadingMsg(loadingMsg) {
            if (loadingMsg && loadingMsg.parentNode) {
                loadingMsg.parentNode.removeChild(loadingMsg);
            }
        }
    </script>
</body>
</html>